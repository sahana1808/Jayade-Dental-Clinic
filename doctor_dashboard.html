<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dentist Clinic — Doctor Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --nav:#0A224C;
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#cfd8e6;
      --accent:#0A224C;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:0;
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      height:100vh;
      display:flex;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      width:260px;
      background:var(--nav);
      color:#fff;
      padding:28px 20px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .brand{
      font-size:20px;
      font-weight:700;
      margin-bottom:10px;
    }
    .menu-item{
      padding:12px 14px;
      border-radius:10px;
      cursor:pointer;
      font-size:15px;
      font-weight:500;
      transition:all .18s;
    }
    .menu-item:hover,
    .menu-item.active{
      background:#fff;
      color:var(--nav);
      font-weight:600;
    }
    .sidebar-spacer{flex:1}

    /* Main */
    .main{
      flex:1;
      padding:24px;
      overflow:auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
    }
    header h2{
      margin:0;
      color:var(--nav);
      font-weight:700;
    }
    .header-right{
      font-size:14px;
      color:#555;
    }
    .btn{
      background:var(--accent);
      color:#fff;
      padding:8px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }

    /* Cards + tables */
    .row{
      display:flex;
      gap:18px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .card{
      background:var(--card);
      padding:18px;
      border-radius:18px;
      box-shadow:0 8px 20px rgba(0,0,0,0.06);
      flex:1;
      border:2px solid var(--nav);
      min-width:300px;
    }
    .card h3{
      margin:0 0 8px;
      color:var(--nav);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .small{font-size:13px;color:#666}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      margin-top:10px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid #e6edf6;
      text-align:left;
      vertical-align:middle;
    }
    th{
      background:var(--nav);
      color:#fff;
    }
    .actions button{
      margin-right:4px;
      margin-bottom:4px;
      font-size:12px;
      padding:6px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
    }
    .btn-status{
      background:#e1ecff;
      color:#0A224C;
    }
    .btn-next{
      background:#0A224C;
      color:#fff;
    }

    .status-pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    .status-Pending{background:#fff3cd;color:#856404;border:1px solid #ffeeba;}
    .status-Confirmed{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
    .status-Completed{background:#cce5ff;color:#004085;border:1px solid #b8daff;}
    .status-Cancelled{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .modal{
      background:#fff;
      padding:18px;
      border-radius:14px;
      min-width:320px;
      max-width:480px;
    }
    label{
      display:block;
      font-weight:600;
      color:var(--nav);
      margin-top:8px;
      font-size:14px;
    }
    input,select,textarea{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1.6px solid var(--muted);
      margin-top:6px;
      font-size:14px;
    }

    footer{
      margin-top:28px;
      color:#666;
      font-size:13px;
    }

    @media(max-width:900px){
      .row{flex-direction:column}
      .sidebar{display:none}
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="brand">Dental Clinic</div>
    <div class="menu-item active" data-section="dashboard">Dashboard</div>
    <div class="menu-item" data-section="patients">Patients</div>
    <div class="menu-item" data-section="appointments">Appointments</div>
    <div class="menu-item" data-section="reminders">Reminders</div>
    <div class="sidebar-spacer"></div>
    <div class="menu-item" onclick="logout()">Logout</div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <header>
      <h2>Doctor Dashboard</h2>
      <div class="header-right" id="doctorInfo"></div>
    </header>

    <div id="content"></div>

    <footer>Version 1.0 • Doctor view</footer>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modalContent"></div>
  </div>

  <script>
  const API_BASE = "http://localhost:5000";

  // Logged-in doctor
  const doctorUser = JSON.parse(localStorage.getItem("dentcare_user")) || {};
  if (!doctorUser.token || doctorUser.role !== "doctor") {
    alert("Doctor not logged in");
    window.location.href = "login.html";
  }

  document.getElementById("doctorInfo").innerText =
    doctorUser.name ? `Logged in as Dr. ${doctorUser.name}` : "Doctor";

  let appointmentsCache = [];
  let remindersCache   = [];

  /** ---------- MODAL HELPERS ---------- **/
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalContent  = document.getElementById("modalContent");

  function showModal(html) {
    modalContent.innerHTML = html;
    modalBackdrop.style.display = "flex";
  }
  function closeModal() {
    modalBackdrop.style.display = "none";
    modalContent.innerHTML = "";
  }
  modalBackdrop.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  /** ---------- API HELPERS ---------- **/
  async function fetchAppointments() {
    try {
      const res = await fetch(`${API_BASE}/api/doctor/appointments`, {
        headers: { "Authorization": "Bearer " + doctorUser.token }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("APPT FETCH ERROR:", data);
        appointmentsCache = [];
        return;
      }
      appointmentsCache = data.appointments || [];
    } catch (err) {
      console.error("APPT FETCH ERROR:", err);
      appointmentsCache = [];
    }
  }

  // status update
  async function updateStatus(apptId, newStatus) {
    if (!confirm(`Change status to ${newStatus}?`)) return;
    try {
      const res = await fetch(`${API_BASE}/api/doctor/appointments/${apptId}/status`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + doctorUser.token
        },
        body: JSON.stringify({ status: newStatus })
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("STATUS UPDATE ERROR:", data);
        alert(data.message || "Failed to update status");
        return;
      }
      await fetchAppointments();
      routeTo(currentSection());
    } catch (err) {
      console.error(err);
      alert("Error while updating status");
    }
  }

  function openNextApptModal(apptId, patientName) {
    const today = new Date().toISOString().slice(0, 10);
    showModal(`
      <h3>Schedule Next Appointment</h3>
      <p class="small">Patient: <b>${patientName}</b></p>
      <label>Next Date</label>
      <input type="date" id="next_date" min="${today}">
      <label>Time Slot</label>
      <select id="next_time">
        <option value="">Select time</option>
        <option>10:00 AM</option>
        <option>11:00 AM</option>
        <option>02:00 PM</option>
        <option>03:00 PM</option>
        <option>05:00 PM</option>
      </select>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="scheduleNext('${apptId}')">Save</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    `);
  }

  async function scheduleNext(apptId) {
    const date = document.getElementById("next_date").value;
    const timeSlot = document.getElementById("next_time").value;
    if (!date || !timeSlot) {
      alert("Please choose date and time");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/doctor/appointments/${apptId}/next`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + doctorUser.token
        },
        body: JSON.stringify({ date, timeSlot })
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("NEXT APPT ERROR:", data);
        alert(data.message || "Failed to schedule next appointment");
        return;
      }
      alert("Next appointment created!");
      closeModal();
      await fetchAppointments();
      routeTo("appointments");
    } catch (err) {
      console.error(err);
      alert("Error while scheduling next appointment");
    }
  }

  /** ---------- REMINDERS (DB) ---------- **/

  async function fetchReminders() {
    try {
      const res = await fetch(`${API_BASE}/api/doctor/reminders`, {
        headers: { "Authorization": "Bearer " + doctorUser.token }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("REM FETCH ERROR:", data);
        remindersCache = [];
        return;
      }
      remindersCache = data.reminders || [];
    } catch (err) {
      console.error("REM FETCH ERROR:", err);
      remindersCache = [];
    }
  }

  function renderRemindersPage() {
    const rows = remindersCache.map(r => {
      const d = r.date ? new Date(r.date).toLocaleDateString("en-GB") : "";
      return `
        <tr>
          <td>${r.patientName}</td>
          <td>${r.description}</td>
          <td>${d}</td>
          <td>
            <button class="btn-status" onclick="markReminderDone('${r._id}')">Done</button>
            <button class="btn-status" onclick="deleteReminder('${r._id}')">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    content.innerHTML = `
      <div class="card">
        <h3>
          Reminders
          <button class="btn" style="font-size:12px" onclick="openReminderForm()">+ Add</button>
        </h3>
        <table>
          <tr>
            <th>Patient</th>
            <th>Description</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
          ${rows || `<tr><td colspan="4">No reminders yet.</td></tr>`}
        </table>
      </div>
    `;
  }

  function openReminderForm() {
    const today = new Date().toISOString().slice(0,10);
    showModal(`
      <h3>New Reminder</h3>
      <label>Patient Name</label>
      <input id="rm_patient" />

      <label>Description</label>
      <textarea id="rm_desc" rows="3"></textarea>

      <label>Date</label>
      <input id="rm_date" type="date" value="${today}">

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="saveReminder()">Save</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    `);
  }

  async function saveReminder() {
    const patientName = document.getElementById("rm_patient").value.trim();
    const description = document.getElementById("rm_desc").value.trim();
    const date        = document.getElementById("rm_date").value;

    if (!patientName || !description || !date) {
      alert("Patient name, description and date are required");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/doctor/reminders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + doctorUser.token
        },
        body: JSON.stringify({ patientName, description, date })
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("REM CREATE ERROR:", data);
        alert(data.message || "Failed to create reminder");
        return;
      }
      closeModal();
      await fetchReminders();
      renderRemindersPage();
    } catch (err) {
      console.error(err);
      alert("Error while creating reminder");
    }
  }

  async function markReminderDone(id) {
    try {
      const res = await fetch(`${API_BASE}/api/doctor/reminders/${id}`, {
        method: "PATCH",
        headers: { "Authorization": "Bearer " + doctorUser.token }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("REM DONE ERROR:", data);
        alert(data.message || "Failed to update reminder");
        return;
      }
      await fetchReminders();
      renderRemindersPage();
    } catch (err) {
      console.error(err);
      alert("Error while updating reminder");
    }
  }

  async function deleteReminder(id) {
    if (!confirm("Delete this reminder?")) return;
    try {
      const res = await fetch(`${API_BASE}/api/doctor/reminders/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + doctorUser.token }
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.error("REM DELETE ERROR:", data);
        alert(data.message || "Failed to delete reminder");
        return;
      }
      await fetchReminders();
      renderRemindersPage();
    } catch (err) {
      console.error(err);
      alert("Error while deleting reminder");
    }
  }

  /** ---------- RENDER HELPERS ---------- **/
  const content = document.getElementById("content");

  function renderDashboard() {
    const todayStr = new Date().toISOString().slice(0, 10);
    const todayAppts = appointmentsCache.filter(a =>
      a.date && a.date.slice(0,10) === todayStr
    );
    const pending = appointmentsCache.filter(a => a.status === "Pending").length;
    const confirmed = appointmentsCache.filter(a => a.status === "Confirmed").length;

    content.innerHTML = `
      <div class="row">
        <div class="card">
          <h3>Today at a glance</h3>
          <p class="small">Overview of your appointments.</p>
          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1;text-align:center">
              <div style="font-size:22px;font-weight:700;color:var(--nav)">${todayAppts.length}</div>
              <div class="small">Today's Appointments</div>
            </div>
            <div style="flex:1;text-align:center">
              <div style="font-size:22px;font-weight:700;color:var(--nav)">${pending}</div>
              <div class="small">Pending</div>
            </div>
            <div style="flex:1;text-align:center">
              <div style="font-size:22px;font-weight:700;color:var(--nav)">${confirmed}</div>
              <div class="small">Confirmed</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Next few appointments</h3>
          <table>
            <tr><th>Date</th><th>Time</th><th>Patient</th><th>Status</th></tr>
            ${
              appointmentsCache
                .slice()
                .sort((a,b)=>new Date(a.date)-new Date(b.date))
                .slice(0,5)
                .map(a => {
                  const d = a.date ? new Date(a.date).toLocaleDateString("en-GB") : "";
                  const pName = a.patient?.name || a.patientName || "Patient";
                  return `
                    <tr>
                      <td>${d}</td>
                      <td>${a.timeSlot || a.time || ""}</td>
                      <td>${pName}</td>
                      <td><span class="status-pill status-${a.status || "Pending"}">${a.status || "Pending"}</span></td>
                    </tr>
                  `;
                }).join("") || `<tr><td colspan="4">No appointments found.</td></tr>`
            }
          </table>
        </div>
      </div>
    `;
  }

  function renderAppointments() {
    content.innerHTML = `
      <div class="card">
        <h3>All Appointments</h3>
        <table>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Patient</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
          ${
            appointmentsCache
              .slice()
              .sort((a,b)=>new Date(a.date)-new Date(b.date))
              .map(a => {
                const d = a.date ? new Date(a.date).toLocaleDateString("en-GB") : "";
                const time = a.timeSlot || a.time || "";
                const pName = a.patient?.name || a.patientName || "Patient";

                const status = a.status || "Pending";
                let actionBtns = "";

                if (status === "Pending") {
                  actionBtns += `<button class="btn-status" onclick="updateStatus('${a._id}','Confirmed')">Confirm</button>`;
                  actionBtns += `<button class="btn-status" onclick="updateStatus('${a._id}','Cancelled')">Cancel</button>`;
                } else if (status === "Confirmed") {
                  actionBtns += `<button class="btn-status" onclick="updateStatus('${a._id}','Completed')">Complete</button>`;
                  actionBtns += `<button class="btn-status" onclick="updateStatus('${a._id}','Cancelled')">Cancel</button>`;
                }

                if (status === "Completed" || status === "Cancelled" || status === "Confirmed") {
                  actionBtns += `<button class="btn-next" onclick="openNextApptModal('${a._id}','${pName.replace(/'/g,"&#39;")}')">Next Visit</button>`;
                }

                return `
                  <tr>
                    <td>${d}</td>
                    <td>${time}</td>
                    <td>${pName}</td>
                    <td><span class="status-pill status-${status}">${status}</span></td>
                    <td class="actions">${actionBtns || "-"}</td>
                  </tr>
                `;
              }).join("") || `<tr><td colspan="5">No appointments found.</td></tr>`
          }
        </table>
      </div>
    `;
  }

  // Patients derived from appointmentsCache
  function renderPatients() {
    const map = new Map();

    appointmentsCache.forEach(a => {
      const p = a.patient || {};
      const id =
        p._id || a.patientId || p.id || p.email || p.name;

      if (!id) return;
      if (!map.has(id)) {
        map.set(id, {
          name:  p.name  || a.patientName || "Patient",
          phone: p.phone || "",
          email: p.email || ""
        });
      }
    });

    const patients = Array.from(map.values());

    content.innerHTML = `
      <div class="card">
        <h3>My Patients</h3>
        <p class="small">Patients who have appointments with you.</p>
        <table>
          <tr><th>Name</th><th>Phone</th><th>Email</th></tr>
          ${
            patients.map(p => `
              <tr>
                <td>${p.name}</td>
                <td>${p.phone || "-"}</td>
                <td>${p.email || "-"}</td>
              </tr>
            `).join("") || `<tr><td colspan="3">No patients yet.</td></tr>`
          }
        </table>
      </div>
    `;
  }

  /** ---------- ROUTING ---------- **/
  function currentSection() {
    const el = document.querySelector(".menu-item.active[data-section]");
    return el ? el.dataset.section : "dashboard";
  }

  async function routeTo(section) {
    document.querySelectorAll(".menu-item[data-section]").forEach(m =>
      m.classList.toggle("active", m.dataset.section === section)
    );

    if (section === "dashboard" || section === "appointments" || section === "patients") {
      if (!appointmentsCache.length) await fetchAppointments();
    }
    if (section === "reminders") {
      await fetchReminders();
    }

    switch (section) {
      case "patients":     renderPatients(); break;
      case "appointments": renderAppointments(); break;
      case "reminders":    renderRemindersPage(); break;
      default:             renderDashboard(); break;
    }
  }

  document.querySelectorAll(".menu-item[data-section]").forEach(item => {
    item.addEventListener("click", () => routeTo(item.dataset.section));
  });

  function logout() {
    if (confirm("Logout?")) {
      localStorage.clear();
      window.location.href = "login.html";
    }
  }

  (async function init() {
    await fetchAppointments();
    await fetchReminders();
    routeTo("dashboard");
  })();

  // expose for inline handlers
  window.updateStatus      = updateStatus;
  window.openNextApptModal = openNextApptModal;
  window.scheduleNext      = scheduleNext;
  window.openReminderForm  = openReminderForm;
  window.saveReminder      = saveReminder;
  window.markReminderDone  = markReminderDone;
  window.deleteReminder    = deleteReminder;
  window.logout            = logout;
  window.routeTo           = routeTo;
  </script>

</body>
</html>
